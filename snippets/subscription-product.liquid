{% comment %}
	to install, insert:
	{% include 'subscription-product' %} 
	above:
	<form action="/cart/add" 
	in product.liquid template
{% endcomment %}

<!-- subscription -->
{% if product.metafields.subscriptions.subscription_id and settings.show_subscription %}
<script>
/*make sure we have jquery available */
var source = '//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'

var arr = $.fn.jquery.split('.');
if (!window.jQuery || arr[0] > 1 || (arr[0] == 1 && arr[1] < 7)) {
	//console.log('jquery not found or not up to date, installing jquery 1.7.1');
	document.write('<script src="'+source+'"><\/script>');
}
</script>

  
{% assign discount_percentage = product.metafields.subscriptions.discount_percentage | floor %}  
{% assign subscription_only = 'false' %}
{% assign subscription_id = product.metafields.subscriptions.subscription_id %}


<section id="recurring_choice_{{product.id}}" {% if subscription_only == 'true'%} style="display:none;" {% endif %}>
	  <div class="radio_option {{product.id}}" id="single_purchase_{{product.id}}">
		  <label for="autodeliver_off_radio_{{product.id}}" id="auto_deliver_label"><span style="color:black;">
			<input type="radio" name="autodeliver_{{product.id}}" class="autodeliver {{product.id}}" value="onetime" {% if subscription_only == 'false' %} checked="" {% endif %} id="autodeliver_off_radio_{{product.id}}"> 
			One-time purchase:</span> <span id="one-time-price_{{product.id}}"></span></label>
	  </div><!--#single_purchase-->
	  <div class="radio_option {{product.id}}" id="recurring_purchase_{{product.id}}">
		  <label for="autodeliver_on_radio_{{product.id}}" id="auto_deliver_label" style="font-weight:bold;">
			<span style="color:black;">
			  <input type="radio" name="autodeliver_{{product.id}}" class="autodeliver {{product.id}}" value="autodeliver" {% if subscription_only == 'true' %} checked="" {% endif %} id="autodeliver_on_radio_{{product.id}}"> 
			  Subscribe &amp; Save</span> <span>{{discount_percentage}}%</span>: <span id="recurring-time-price_{{product.id}}"></span>
		  </label>
	
		<div class="offer_newline">
			<label>
				<span style="color:black;margin-left:0px;"> 
				
				{% if product.metafields.subscriptions.shipping_interval_unit_type.size > 0%}
					{% assign shipping_interval_unit_type = product.metafields.subscriptions.shipping_interval_unit_type %}  
				{% else %}
					{% assign shipping_interval_unit_type = 'Days' %}
				{% endif %}
				
				{% if product.metafields.subscriptions.shipping_interval_frequency.size > 0 %}
					{% assign shipping_interval_frequency = product.metafields.subscriptions.shipping_interval_frequency | split: ',' %}
				{% else %}
					{% assign shipping_interval_frequency = '30' %}
				{% endif %}
				
				<input type="hidden" name="shipping_interval_unit_type" id="shipping_interval_unit_type_{{product.id}}" value="{{shipping_interval_unit_type}}" >
				Deliver every 
				{% if shipping_interval_frequency.size == 1 %}
					<span >{{shipping_interval_frequency[0]}} {{shipping_interval_unit_type}}</span>
					<input type="hidden" name="shipping_interval_frequency" id="shipping_interval_frequency_{{product.id}}" value="{{shipping_interval_frequency}}">

				{%elsif shipping_interval_frequency.size > 1%}
					<select name="shipping_interval_frequency" id="shipping_interval_frequency_{{product.id}}">
					  {% for frequency in shipping_interval_frequency %}
					  <option value="{{frequency}}">{{frequency}} {{shipping_interval_unit_type}}</option>
					  {% endfor %}
					</select>
				{% endif %}
				</span>
			</label>
			
			<a class="subscription-tooltip" href="#" id="see-details" style="margin-left:0px;text-transform:none;">See details 
				<span> <strong>Here’s How It Works:</strong>
				  <br>• Save 15% and Save Time!<br>	
                  <br>• Your favorite supplements delivered automatically on your schedule<br>
					<br>• No obligation, change or cancel at anytime
				</span>
			</a>
		</div><!--.offer_newline-->
	  </div><!--#recurring_purchase-->
  </section>

  <style>
  /* Tool Tip CSS */
  a.subscription-tooltip {
      outline:none; 
      position:relative !important;
  }
  a.subscription-tooltip strong {line-height:30px;}
  a.subscription-tooltip:hover {text-decoration:none;}
  a.subscription-tooltip span {
          z-index:10;
          display:none;
          padding:14px 20px;
          margin-top: 20px;
          margin-left:28px;
          width:240px;
          line-height:16px;
  }
  a.subscription-tooltip:hover span{
          display:inline;
          position:absolute;
          left:-250px;
          color:#111;
          border:1px solid #333;
          background:white;

  }
  a.subscription-tooltip span{
          -moz-box-shadow: 5px 5px 8px #CCC;
          -webkit-box-shadow: 5px 5px 8px #CCC;
          box-shadow: 5px 5px 8px #CCC;
  }

  /* Recurring Upsell Widget CSS */
  .radio_option {
      border-radius:4px;
      cursor:pointer;
      margin:0px 0px 10px 0px;
      padding:8px;
      font-family:"Arial","Helvetica",sans-serif;
      width:98%;
      border: 1px solid transparent;
  }
  .radio_option.active {
      border:1px solid #d9d9d9 !important;
      background-color:#f1f1f1 !important;
  }
  .radio_option input {
      margin:0 4px 0 0;
      padding:0 0 0 5px;
  }
  .radio_option input[type="number"] {
      width:40px;
  }
  #auto_deliver_label {
      font-weight:bold !important;
      width:90% !important;
  }
  .radio_option label {
      width:auto;
      font-weight:normal !important;
      position:relative;
      display:inline-block
  }
  .label_black_text {
      color:rgb(0,0,0);
      font-family:"Arial";
      font-weight:bold;
      margin-left:21px;
  }
  .offer_newline {
      margin-top:5px;
  }
  #see-details {
      color:rgb(86,148,82);
      text-decoration:underline;
      text-transform:none;
    opacity:1;
  }
  .ui-widget-content {
      font-family:Verdana,Arial,sans-serif;
      color: red !important;
  }

  #recurring_choice {
    width: 100%;
    margin-left: 0px;
    margin-top: 10px;
    margin-bottom: 10px;
    font-size:13px;
  }
  
  #single_purchase {
   margin-bottom:5px; 
  }
  
  select#shipping_interval_frequency_{{product.id}} {
      display:inline-block;
      height: auto;
  }
  .radio_option label {
  cursor:pointer;
  }
  /* fix for launchpad*/
  .autodeliver {
  	-webkit-appearance:radio;
  }
  
  /*Client requested changes */
  #see-details, #save-percentage {
      color:#f89c34;
  }
    
  /* Recurring Upsell Widget HTML */
  </style>
  
  
	<script>
	      
    var currentPrice = $('.current_price, .money.your-price, #price-preview').html('')
    if($('.current_price, .money.your-price, #price-preview').size() > 1){
        currentPrice = $('.current_price {{product.id}}, .money.your-price.{{product.id}}, #price-preview-{{product.id}}').html('')
	}
	  window.discount_percentage_{{product.id}} = {{ product.metafields.subscriptions.discount_percentage | floor }}
	/* for changing background color when a selection is clicked */
	  $('body').on('click','.autodeliver.{{product.id}}',function() {
		//console.log('clicked')

		$('.radio_option.{{product.id}}').removeClass('active')
		$(this).parent().parent().addClass('active')
  
		if( $(this).val()=='autodeliver' ) {
		  $('#recurring_purchase_{{product.id}}').addClass('active')
		  $('#single_purchase_{{product.id}}').removeClass('active')
  
		} else if( $(this).val()=='onetime' ) {
		  $('#recurring_purchase_{{product.id}}').removeClass('active')
		  $('#single_purchase_{{product.id}}').addClass('active')
		}
        if(discount_percentage_{{product.id}} > 0) {
          updatePrice_{{product.id}}("UPDATE - Change radio");    
        }
	  })
	</script>
	
	<script>
		/* setting listeners for taking over form/buttons */
		/*$('body').on("submit","form[action='/cart/add']",function () {
			return false;
		});*/
		
		function getSubscriptionVariantId_{{product.id}} (variant_id, quantity) {
			/*check if user selected subscription option and if so, do the stuff for that*/
          	if( $('#autodeliver_on_radio_{{product.id}}').prop('checked')==true ) {
				/* check if there is a discount and if so use the hidden product variant */
               if(variant_mapping_{{product.id}}[variant_id]['discount_variant_id'] !='' && variant_mapping_{{product.id}}[variant_id]['discount_variant_id'] != undefined) {
					discount_variant_id = variant_mapping_{{product.id}}[variant_id]['discount_variant_id']
                    variant_id = discount_variant_id
				}
                var shipping_interval_frequency = $('#shipping_interval_frequency_{{product.id}}').val()
				addItemToCart_{{product.id}}(variant_id, quantity, shipping_interval_frequency)
			} else {
				addItemToCart_{{product.id}}(variant_id, quantity, false)
			}
					
		}//end getSubscriptionVariantId()
		
		function addItemToCart_{{product.id}}(variant_id, quantity, shipping_interval_frequency) {
			 
		  data = {
				"quantity": quantity,
				"id": variant_id
			  }
		  if(shipping_interval_frequency) {
			data['properties[shipping_interval_frequency]']=shipping_interval_frequency
			data['properties[shipping_interval_unit_type]']=$('#shipping_interval_unit_type_{{product.id}}').val()
			data['properties[subscription_id]']= {{subscription_id}}
			data['properties[discount_percentage]']= {{discount_percentage}}
		  } 
		  //debugger;
		  jQuery.ajax({
			  type: 'POST',
			  url: '/cart/add.js',
			  data: data,
			  dataType: 'json',
			  success: function() { 
				//console.log('add success');
				  window.location.href = '/cart'; //reload page
			  },
			  fail: function() {
				  //console.log('fail')
			  }
			});
		}
		
		$(document).ready(function(){
			$( '#add-to-cart, .add-to-cart, #add' ).unbind();
			$( '#add-to-cart, .add-to-cart, #add' ).off(); 
		})
		
		$('body').on('click','#add-to-cart, #add, .add-to-cart, #add-item-to-cart, .add-to-cart-{{product.id}}',function(event) {
			event.preventDefault()

			if($('[name="id"]').size() > 1){
				$('[name="id"]').each(function(index){
			        if( $(this).data('productid') == {{product.id}}){
			          var variant_id = $(this).val()
			          var quantity = $('[id="quantity_{{product.id}}"]').val()
			          getSubscriptionVariantId_{{product.id}}(variant_id, quantity)
			        }
			    })
			}else{
				variant_id = $('[name="id"]').val()
				quantity = $('[name="quantity"]').val()
				getSubscriptionVariantId_{{product.id}}(variant_id, quantity)
			}	
        }) 
		
	</script>
	
	<script type="text/javascript">
	//set variant mapping for the case in which there is an automatically created duplicate product
	  var variant_mapping_{{product.id}} = {};  
	  var variant_price_mapping_{{product.id}} ={}
	  
	  {% for variant in product.variants %}
	  
		  var discount_variant_id = '{{ variant.metafields.subscriptions.discount_variant_id }}'
		  variant_mapping_{{product.id}}['{{variant.id}}']='' 
		  
		  if(discount_variant_id) {
			variant_mapping_{{product.id}}['{{variant.id}}'] = {"discount_variant_id":discount_variant_id};
		  }
		  var discount_variant_price = '{{ variant.metafields.subscriptions.discount_variant_price }}'
		  variant_price_mapping_{{product.id}}['{{variant.id}}']=''
		  if(discount_variant_price) {
			variant_price_mapping_{{product.id}}['{{variant.id}}'] = {"discount_variant_price":discount_variant_price};
		 }
			 
		  //console.log('discount_variant_id '+discount_variant_id)
	  {% endfor %}
	
	</script> 
	
	<script>
	//update price dynamically

	  $(document).ready(function(){
		
		var currentPrice = $('.current_price, .money.your-price, #price-preview').html('')
	  	if($('.current_price, .money.your-price, #price-preview').size() > 1){
		  	currentPrice = $('.current_price.{{product.id}}, .money.your-price.{{product.id}}, #price-preview-{{product.id}}').html('')
		}

		currentPrice.bind("DOMSubtreeModified",function(){      
		  if( window.get_tax_lock_{{product.id}} == false ){
			window.get_tax_lock_{{product.id}} = true;
			if(discount_percentage_{{product.id}} > 0) {
				updatePrice_{{product.id}}("UPDATE - DOMSubtreeModified");
			}
			setTimeout(function(){window.get_tax_lock_{{product.id}}=false}, 200);
		  }
		});
	
		$('#quantity').on("change",function(){
			if(discount_percentage_{{product.id}} > 0) {
				updatePrice_{{product.id}}("UPDATE - Qty change on");
			}
		});
	
	  })
	
		function updatePrice_{{product.id}}(text) {
		  //console.log(text);
		  if($('.current_price, .money.your-price, #price-preview').size() > 1){
            $('.current_price.{{product.id}}, .money.your-price.{{product.id}}, #price-preview-{{product.id}}').html('');
		  }else{
		  	$('.current_price, .money.your-price, #price-preview').html('')
		  }		  
		  
          var variant_id = $('[name="id"]').val()      
		  var quantity = $('[name="quantity"]').val()
          
          if($('[name="id"]').size() > 1){
				$('[name="id"]').each(function(index){
			        if( $(this).data('productid') == {{product.id}}){
			          variant_id = $(this).val()
			          quantity = $('[id="quantity_{{product.id}}"]').val()
			          
			        }
			    })
			}else{
				variant_id = $('[name="id"]').val()
				quantity = $('[name="quantity"]').val()
			}
          
          
		  if(typeof quantity === 'undefined'){
			quantity = 1;
		  }
		  var variant_price_{{product.id}} =0
	
		  if( $('#autodeliver_on_radio_{{product.id}}').prop('checked')==true ) {
			  if(variant_mapping_{{product.id}}[variant_id]['discount_variant_id'] !='') {
				 variant_price_{{product.id}} = variant_price_mapping_{{product.id}}[variant_id]['discount_variant_price']
			  }
		  } else {
				variant_price_{{product.id}} = (variant_prices_{{product.id}}[variant_id] / 100) 
		  }
	
		  variant_price_{{product.id}} = parseFloat(variant_price_{{product.id}}).toFixed(2)
		  var displayed_price = parseFloat(quantity * variant_price_{{product.id}}).toFixed(2)
		  var price_string = '$'+displayed_price      
		  if(window.first_time_{{product.id}}){
		  	if($('.current_price, .money.your-price, #price-preview').size() > 1){
		  		$('.current_price.{{product.id}}, .money.your-price.{{product.id}}, #price-preview-{{product.id}}').html(price_string)
		  	}else{
		  		$('.current_price, .money.your-price, #price-preview').html(price_string)
		  	}
	          	            
          }
          window.first_time_{{product.id}} = true;
          updateInlinePrice();
		}
	
		//map original prices for updated price calculations
		  variant_prices_{{product.id}}={}
		{% for variant in product.variants %}
			  variant_prices_{{product.id}}['{{variant.id}}'] = "{{variant.price}}"
		{% endfor %} 
	</script>
	
	<script>
	  //make sure correct option has grey border
	  $(document).ready(function(){
		window.get_tax_lock_{{product.id}} = false;
        window.first_time_{{product.id}} = true;
		if($('#autodeliver_on_radio_{{product.id}}').prop('checked')==true ) {
		  $('#recurring_purchase_{{product.id}}').addClass('active');
		  if(discount_percentage_{{product.id}} > 0) {
			  setTimeout(function(){ updatePrice_{{product.id}}("");}, 200);
		  }
		}else {
		  $('#single_purchase_{{product.id}}').addClass('active');
		  if(discount_percentage_{{product.id}} > 0) {
			  setTimeout(function(){updatePrice_{{product.id}}("");}, 200);
		  }
		}
		
	  });
	</script>
	
	<script>

      $(document).ready(function(){    
        updateInlinePrice();
      })

      function updateInlinePrice(){
        var variant_id_{{product.id}} = $('[name="id"]').val();
        if($('[name="id"]').size() > 1){
          $('[name="id"]').each(function(index){
            if( $(this).data('productid') == {{product.id}}){
               variant_id_{{product.id}} = $(this).val();
          }
                                })
        }
        var price_one_time_{{product.id}} = (variant_prices_{{product.id}}[variant_id_{{product.id}}] / 100);
        price_one_time_{{product.id}} = parseFloat(price_one_time_{{product.id}}).toFixed(2);
        var price_recurring_{{product.id}} = (variant_prices_{{product.id}}[variant_id_{{product.id}}] / 100) * ( 1 - 0.{{discount_percentage}}) ;
        price_recurring_{{product.id}} = parseFloat(price_recurring_{{product.id}}).toFixed(2);

        $('#one-time-price_{{product.id}}').text(" $"+ price_one_time_{{product.id}});
        $('#recurring-time-price_{{product.id}}').text(" $"+ price_recurring_{{product.id}});
        
        updateSavingPrice();
      }
      
	  function updateSavingPrice(){        
        if($('#autodeliver_on_radio_{{product.id}}').prop('checked')==true ) {
          {% if product.compare_at_price_max > product.price %}
           {% assign minPrice = product.price_min | times:0.89 %}
           {% assign RRP = product.compare_at_price_min %}
           {% assign youSave = RRP | minus:minPrice %}
           {% assign youSavePerc = youSave | times:100 | divided_by:RRP %}
          $('.money.savings').text('{{ youSave | money }} ({{ youSavePerc | round:1 }}%)');
          {% endif %}          
        }else {
           {% if product.compare_at_price_max > product.price %}
           {% assign minPrice = product.price_min %}
           {% assign RRP = product.compare_at_price_min %}
           {% assign youSave = RRP | minus:minPrice %}
           {% assign youSavePerc = youSave | times:100 | divided_by:RRP %}
          $('.money.savings').text('{{ youSave | money }} ({{ youSavePerc | round:1 }}%)');
          {% endif %}
          
        }
      }
      
</script>
<div id="test" style="display:none;">{{product | json}}</div>
<!-- v1.5 -->
{% endif %}
